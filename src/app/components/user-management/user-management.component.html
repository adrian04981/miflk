<div class="user-management">
  <div class="header-section">
    <mat-card class="header-card">
      <mat-card-content>
        <div class="header-content">
          <div class="header-text">
            <h1><i class="fas fa-users"></i> Gestión de Usuarios</h1>
            <p class="header-subtitle">Administra y controla los usuarios del sistema</p>
            <div class="header-stats">
              <span class="stat-badge"><i class="fas fa-user-check"></i> Total: {{ users.length }}</span>
              <span class="stat-badge active"><i class="fas fa-circle"></i> Activos: {{ getActiveUsersCount() }}</span>
            </div>
          </div>
          <button mat-raised-button 
                  color="primary" 
                  class="add-user-btn"
                  (click)="showCreateUserForm()"
                  [disabled]="showUserForm">
            <i class="fas fa-plus"></i>
            Nuevo Usuario
          </button>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="form-section" *ngIf="showUserForm">
    <mat-card class="form-card">
      <mat-card-header>
        <mat-card-title>
          <i class="fas fa-user-edit"></i>
          {{ editingUser ? 'Editar Usuario' : 'Crear Usuario' }}
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <form [formGroup]="userForm" (ngSubmit)="onSubmit()">
          <div class="form-grid">
            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-envelope"></i> Email</mat-label>
              <input matInput type="email" formControlName="email" placeholder="ejemplo@correo.com">
              <mat-error *ngIf="userForm.get('email')?.hasError('required')">
                Email es requerido
              </mat-error>
              <mat-error *ngIf="userForm.get('email')?.hasError('email')">
                Email inválido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" *ngIf="!editingUser">
              <mat-label><i class="fas fa-lock"></i> Contraseña</mat-label>
              <input matInput type="password" formControlName="password" placeholder="Contraseña">
              <mat-error *ngIf="userForm.get('password')?.hasError('required')">
                Contraseña es requerida
              </mat-error>
              <mat-error *ngIf="userForm.get('password')?.hasError('minlength')">
                Mínimo 6 caracteres
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-user"></i> Nombres</mat-label>
              <input matInput formControlName="firstName" placeholder="Nombres">
              <mat-error *ngIf="userForm.get('firstName')?.hasError('required')">
                Nombres son requeridos
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-user"></i> Apellidos</mat-label>
              <input matInput formControlName="lastName" placeholder="Apellidos">
              <mat-error *ngIf="userForm.get('lastName')?.hasError('required')">
                Apellidos son requeridos
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-globe"></i> Nacionalidad</mat-label>
              <input matInput formControlName="nationality" placeholder="Nacionalidad">
              <mat-error *ngIf="userForm.get('nationality')?.hasError('required')">
                Nacionalidad es requerida
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-id-card"></i> Tipo de Documento</mat-label>
              <mat-select formControlName="documentType">
                <mat-option *ngFor="let type of documentTypeOptions" [value]="type.value">
                  {{ type.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="userForm.get('documentType')?.hasError('required')">
                Tipo de documento es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-hashtag"></i> Número de Documento</mat-label>
              <input matInput formControlName="documentNumber" placeholder="Número de documento">
              <mat-error *ngIf="userForm.get('documentNumber')?.hasError('required')">
                Número de documento es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-map-marker-alt"></i> País de Residencia</mat-label>
              <input matInput formControlName="countryOfResidence" placeholder="País de residencia">
              <mat-error *ngIf="userForm.get('countryOfResidence')?.hasError('required')">
                País de residencia es requerido
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-phone"></i> Teléfono</mat-label>
              <input matInput formControlName="phoneNumber" placeholder="Teléfono (opcional)">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label><i class="fas fa-user-shield"></i> Rol</mat-label>
              <mat-select formControlName="role">
                <mat-option *ngFor="let role of roleOptions" [value]="role.value">
                  <i class="fas fa-shield-alt"></i> {{ role.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="userForm.get('role')?.hasError('required')">
                Rol es requerido
              </mat-error>
            </mat-form-field>

            <div class="toggle-field">
              <mat-slide-toggle formControlName="isActive">
                <i class="fas fa-power-off"></i> Usuario Activo
              </mat-slide-toggle>
            </div>
          </div>

          <div class="form-actions">
            <button mat-button type="button" class="cancel-btn" (click)="cancelForm()">
              <i class="fas fa-times"></i>
              Cancelar
            </button>
            <button mat-raised-button color="primary" type="submit" class="submit-btn" [disabled]="!userForm.valid">
              <i class="fas fa-save"></i>
              {{ editingUser ? 'Actualizar' : 'Crear' }} Usuario
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  </div>

  <div class="table-section">
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>
          <i class="fas fa-table"></i>
          Lista de Usuarios
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="users" class="users-table">
            <!-- Nombre Column -->
            <ng-container matColumnDef="displayName">
              <th mat-header-cell *matHeaderCellDef>Usuario</th>
              <td mat-cell *matCellDef="let user">
                <div class="user-info">
                  <div class="user-avatar">
                    {{ getUserInitials(user) }}
                  </div>
                  <div class="user-details">
                    <div class="user-name">{{ user.personalInfo?.firstName }} {{ user.personalInfo?.lastName }}</div>
                    <div class="user-email">{{ user.email }}</div>
                  </div>
                </div>
              </td>
            </ng-container>

            <ng-container matColumnDef="email">
              <th mat-header-cell *matHeaderCellDef>Email</th>
              <td mat-cell *matCellDef="let user">{{ user.email }}</td>
            </ng-container>

            <ng-container matColumnDef="role">
              <th mat-header-cell *matHeaderCellDef>Rol</th>
              <td mat-cell *matCellDef="let user">
                <span [class]="user.role === UserRole.ADMIN ? 'role-admin' : 'role-employee'">
                  {{ getRoleLabel(user.role) }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="nationality">
              <th mat-header-cell *matHeaderCellDef>Nacionalidad</th>
              <td mat-cell *matCellDef="let user">{{ user.personalInfo.nationality }}</td>
            </ng-container>

            <ng-container matColumnDef="documentType">
              <th mat-header-cell *matHeaderCellDef>Tipo Doc.</th>
              <td mat-cell *matCellDef="let user">{{ getDocumentTypeLabel(user.personalInfo.documentType) }}</td>
            </ng-container>

            <ng-container matColumnDef="documentNumber">
              <th mat-header-cell *matHeaderCellDef>Nº Documento</th>
              <td mat-cell *matCellDef="let user">{{ user.personalInfo.documentNumber }}</td>
            </ng-container>

            <ng-container matColumnDef="isActive">
              <th mat-header-cell *matHeaderCellDef>Estado</th>
              <td mat-cell *matCellDef="let user">
                <span [class]="user.isActive ? 'status-active' : 'status-inactive'">
                  {{ user.isActive ? 'Activo' : 'Inactivo' }}
                </span>
              </td>
            </ng-container>

            <ng-container matColumnDef="actions">
              <th mat-header-cell *matHeaderCellDef>Acciones</th>
              <td mat-cell *matCellDef="let user">
                <button mat-icon-button (click)="editUser(user)" [disabled]="showUserForm">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button 
                        (click)="toggleUserStatus(user)"
                        [disabled]="showUserForm">
                  <mat-icon>{{ user.isActive ? 'block' : 'check_circle' }}</mat-icon>
                </button>
                <button mat-icon-button 
                        (click)="deleteUser(user)"
                        [disabled]="showUserForm"
                        color="warn">
                  <mat-icon>delete</mat-icon>
                </button>
              </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>

          <div class="loading-container" *ngIf="loading">
            <mat-spinner></mat-spinner>
          </div>

          <div class="empty-state" *ngIf="!loading && users.length === 0">
            <mat-icon>people_outline</mat-icon>
            <h3>No hay usuarios</h3>
            <p>Crea tu primer usuario para comenzar</p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</div>
